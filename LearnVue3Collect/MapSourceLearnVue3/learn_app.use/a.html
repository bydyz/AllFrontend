<!DOCTYPE html>
<html>
  <head>
    <title>自定义插件开发</title>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import {
        createApp,
        ref,
        watch,
        inject,
      } from '../vueSource/vue.runtime.esm-bundler.js';

      // 1. 自定义插件 - API 客户端
      const apiPlugin = {
        install(app, options) {
          const baseURL = options?.baseURL || '/api';

          // 创建 API 客户端实例
          const api = {
            async get(endpoint) {
              console.log(`GET ${baseURL}${endpoint}`);
              // 模拟 API 调用
              return new Promise((resolve) => {
                setTimeout(() => {
                  resolve({
                    data: `来自 ${endpoint} 的数据`,
                    status: 200,
                  });
                }, 1000);
              });
            },

            async post(endpoint, data) {
              console.log(
                `POST ${baseURL}${endpoint}`,
                data
              );
              return new Promise((resolve) => {
                setTimeout(() => {
                  resolve({
                    data: { id: 1, ...data },
                    status: 201,
                  });
                }, 1000);
              });
            },
          };

          // 提供 API 给所有组件
          app.provide('api', api);

          // 也添加到全局属性（可选）
          app.config.globalProperties.$api = api;
        },
      };

      // 2. 自定义插件 - 主题管理
      const themePlugin = {
        install(app) {
          const currentTheme = ref('light');

          const theme = {
            current: currentTheme,
            setTheme(themeName) {
              currentTheme.value = themeName;
              document.body.className = `theme-${themeName}`;
            },
            toggle() {
              this.setTheme(
                currentTheme.value === 'light'
                  ? 'dark'
                  : 'light'
              );
            },
          };

          app.provide('theme', theme);
          app.config.globalProperties.$theme = theme;
        },
      };

      // 3. 自定义插件 - 权限管理
      const authPlugin = {
        install(app, options) {
          const user = ref(null);
          const permissions = ref(new Set());

          const auth = {
            user,
            permissions,

            login(userData, userPermissions) {
              user.value = userData;
              permissions.value = new Set(userPermissions);
              localStorage.setItem(
                'auth',
                JSON.stringify({
                  user: userData,
                  permissions: userPermissions,
                })
              );
            },

            logout() {
              user.value = null;
              permissions.value = new Set();
              localStorage.removeItem('auth');
            },

            hasPermission(permission) {
              return permissions.value.has(permission);
            },

            // 初始化从 localStorage 恢复
            init() {
              const saved = localStorage.getItem('auth');
              if (saved) {
                const {
                  user: savedUser,
                  permissions: savedPermissions,
                } = JSON.parse(saved);
                this.login(savedUser, savedPermissions);
              }
            },
          };

          // 提供 auth 给所有组件
          app.provide('auth', auth);
          app.config.globalProperties.$auth = auth;

          // 添加全局权限指令
          app.directive('permission', {
            mounted(el, binding) {
              if (!auth.hasPermission(binding.value)) {
                el.style.display = 'none';
              }
            },
          });
        },
      };

      // 4. 主组件
      const App = {
        template: `
                <div :class="['app', theme.current]">
                    <h1>自定义插件示例</h1>
                    
                    <!-- 主题切换 -->
                    <div style="margin: 20px 0;">
                        <button @click="theme.toggle()">
                            切换主题 (当前: {{ theme.current }})
                        </button>
                    </div>
                    
                    <!-- 权限控制 -->
                    <div style="margin: 20px 0;">
                        <button @click="loginAsUser">以用户身份登录</button>
                        <button @click="loginAsAdmin">以管理员身份登录</button>
                        <button @click="auth.logout()" v-if="auth.user">退出</button>
                        
                        <div v-if="auth.user" style="margin-top: 10px;">
                            当前用户: {{ auth.user.name }}
                        </div>
                    </div>
                    
                    <!-- 权限控制的内容 -->
                    <div>
                        <button v-permission="'read'">读取按钮 (需要 read 权限)</button>
                        <button v-permission="'write'">写入按钮 (需要 write 权限)</button>
                        <button v-permission="'admin'">管理按钮 (需要 admin 权限)</button>
                    </div>
                    
                    <!-- API 测试 -->
                    <div style="margin: 20px 0;">
                        <button @click="fetchData" :disabled="loading">
                            {{ loading ? '加载中...' : '获取数据' }}
                        </button>
                        <div v-if="data" style="margin-top: 10px;">
                            数据: {{ data }}
                        </div>
                    </div>
                </div>
            `,
        setup() {
          // 使用注入的插件功能
          const api = inject('api');
          const theme = inject('theme');
          const auth = inject('auth');

          const data = ref(null);
          const loading = ref(false);

          // 初始化主题
          theme.setTheme('light');

          // 初始化认证
          auth.init();

          const fetchData = async () => {
            loading.value = true;
            try {
              const response = await api.get('/users');
              data.value = response.data;
            } catch (error) {
              console.error('获取数据失败:', error);
            } finally {
              loading.value = false;
            }
          };

          const loginAsUser = () => {
            auth.login({ name: '普通用户' }, ['read']);
          };

          const loginAsAdmin = () => {
            auth.login({ name: '管理员' }, [
              'read',
              'write',
              'admin',
            ]);
          };

          return {
            api,
            theme,
            auth,
            data,
            loading,
            fetchData,
            loginAsUser,
            loginAsAdmin,
          };
        },
      };

      // 5. 创建应用并注册所有自定义插件
      const app = createApp(App);

      // 使用自定义插件
      app.use(apiPlugin, {
        baseURL: 'https://api.example.com',
      });
      app.use(themePlugin);
      app.use(authPlugin);

      // 添加样式
      const style = document.createElement('style');
      style.textContent = `
            .theme-light { background: white; color: black; }
            .theme-dark { background: #333; color: white; }
            .app { padding: 20px; transition: all 0.3s; }
            button { margin: 5px; padding: 8px 16px; }
        `;
      document.head.appendChild(style);

      // 挂载应用
      app.mount('#app');
    </script>
  </body>
</html>
