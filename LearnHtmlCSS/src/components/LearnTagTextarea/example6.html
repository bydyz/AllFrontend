<!DOCTYPE html>
<html>
<head>
<style>
.container {
  margin: 20px;
  padding: 20px;
}

.complete-control {
  width: 400px;
  height: 150px;
  padding: 12px;
  border: 2px solid #2c3e50;
  border-radius: 8px;
  font-size: 14px;
  font-family: Arial, sans-serif;
  resize: none;
}

.control-panel {
  background: #ecf0f1;
  padding: 15px;
  margin: 15px 0;
  border-radius: 8px;
}

.control-group {
  margin: 10px 0;
}

.status-panel {
  background: #34495e;
  color: #ecf0f1;
  padding: 10px;
  border-radius: 5px;
  font-family: monospace;
  min-height: 60px;
  max-height: 100px;
  overflow-y: auto;
}

.btn {
  padding: 8px 16px;
  margin: 5px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.btn-enable { background: #2ecc71; color: white; }
.btn-disable { background: #e74c3c; color: white; }
.btn-info { background: #3498db; color: white; }
</style>
</head>
<body>
  <script src="/run.js"></script>
  <div>
    <button onclick="window.MyUtils.onBackToParent()">返回上一级</button>
  </div>

  <div class="container">
    <h3>6. 完整的输入控制解决方案</h3>
    
    <textarea id="completeControl" class="complete-control" placeholder="测试各种输入限制..."></textarea>
    
    <div class="control-panel">
      <div class="control-group">
        <strong>输入控制:</strong>
        <button class="btn btn-enable" onclick="enableInput()">允许输入</button>
        <button class="btn btn-disable" onclick="disableInput()">禁止输入</button>
        <button class="btn btn-info" onclick="clearTextarea()">清空内容</button>
      </div>
      
      <div class="control-group">
        <strong>IME 控制:</strong>
        <button class="btn btn-enable" onclick="enableIME()">允许 IME</button>
        <button class="btn btn-disable" onclick="disableIME()">禁止 IME</button>
      </div>
      
      <div class="control-group">
        <label>
          <input type="checkbox" id="allowPaste" onchange="togglePaste()"> 允许粘贴
        </label>
        <label>
          <input type="checkbox" id="allowDrop" onchange="toggleDrop()"> 允许拖放
        </label>
      </div>
    </div>
    
    <div class="status-panel" id="statusPanel">
      状态信息将显示在这里...
    </div>
  </div>

  <script>
    class TextareaController {
      constructor(textareaId) {
        this.textarea = document.getElementById(textareaId);
        this.statusPanel = document.getElementById('statusPanel');
        
        // 控制状态
        this.isInputEnabled = true;
        this.isIMEEnabled = true;
        this.isPasteEnabled = true;
        this.isDropEnabled = true;
        this.isComposing = false;
        
        this.bindEvents();
        this.updateStatus();
      }
      
      bindEvents() {
        // 键盘事件
        this.textarea.addEventListener('keydown', this.handleKeyDown.bind(this));
        this.textarea.addEventListener('keyup', this.handleKeyUp.bind(this));
        
        // IME 事件
        this.textarea.addEventListener('compositionstart', this.handleCompositionStart.bind(this));
        this.textarea.addEventListener('compositionupdate', this.handleCompositionUpdate.bind(this));
        this.textarea.addEventListener('compositionend', this.handleCompositionEnd.bind(this));
        
        // 其他输入事件
        this.textarea.addEventListener('paste', this.handlePaste.bind(this));
        this.textarea.addEventListener('drop', this.handleDrop.bind(this));
        this.textarea.addEventListener('input', this.handleInput.bind(this));
        
        // 上下文菜单
        this.textarea.addEventListener('contextmenu', this.handleContextMenu.bind(this));
      }
      
      handleKeyDown(e) {
        if (!this.isInputEnabled) {
          this.log(`阻止了按键: ${e.key} (代码: ${e.keyCode})`);
          e.preventDefault();
          return false;
        }
        
        // IME 输入过程中的特殊处理
        if (this.isComposing && !this.isIMEEnabled) {
          if (e.keyCode === 32 || e.keyCode === 13) { // 空格或回车
            this.log(`阻止了 IME 确认键: ${e.key}`);
            e.preventDefault();
            return false;
          }
        }
      }
      
      handleKeyUp(e) {
        this.log(`按键释放: ${e.key}`);
      }
      
      handleCompositionStart(e) {
        this.isComposing = true;
        this.log('IME 输入开始');
        
        if (!this.isIMEEnabled) {
          this.log('IME 输入已被阻止');
          e.preventDefault();
        }
      }
      
      handleCompositionUpdate(e) {
        if (!this.isIMEEnabled) {
          this.log(`正在输入: "${e.data}" (已被阻止)`);
          e.preventDefault();
        } else {
          this.log(`正在输入: "${e.data}"`);
        }
      }
      
      handleCompositionEnd(e) {
        this.isComposing = false;
        this.log('IME 输入结束');
        
        if (!this.isIMEEnabled) {
          e.preventDefault();
          // 清理可能输入的中文字符
          this.textarea.value = this.textarea.value.replace(/[\u4e00-\u9fa5]/g, '');
        }
      }
      
      handlePaste(e) {
        if (!this.isPasteEnabled) {
          this.log('粘贴操作已被阻止');
          e.preventDefault();
          return false;
        }
        this.log('允许粘贴操作');
      }
      
      handleDrop(e) {
        if (!this.isDropEnabled) {
          this.log('拖放操作已被阻止');
          e.preventDefault();
          return false;
        }
        this.log('允许拖放操作');
      }
      
      handleInput(e) {
        if (!this.isIMEEnabled && this.isComposing) {
          // 在 IME 输入过程中过滤中文字符
          this.textarea.value = this.textarea.value.replace(/[\u4e00-\u9fa5]/g, '');
        }
        this.log('输入事件触发');
      }
      
      handleContextMenu(e) {
        this.log('右键菜单被阻止');
        e.preventDefault();
        return false;
      }
      
      // 控制方法
      enableInput() {
        this.isInputEnabled = true;
        this.textarea.readOnly = false;
        this.log('输入已启用');
        this.updateStatus();
      }
      
      disableInput() {
        this.isInputEnabled = false;
        this.log('输入已禁用');
        this.updateStatus();
      }
      
      enableIME() {
        this.isIMEEnabled = true;
        this.log('IME 输入已启用');
        this.updateStatus();
      }
      
      disableIME() {
        this.isIMEEnabled = false;
        this.log('IME 输入已禁用');
        this.updateStatus();
      }
      
      allowPaste(allow) {
        this.isPasteEnabled = allow;
        this.log(allow ? '粘贴已允许' : '粘贴已禁止');
        this.updateStatus();
      }
      
      allowDrop(allow) {
        this.isDropEnabled = allow;
        this.log(allow ? '拖放已允许' : '拖放已禁止');
        this.updateStatus();
      }
      
      clear() {
        this.textarea.value = '';
        this.log('内容已清空');
      }
      
      log(message) {
        const timestamp = new Date().toLocaleTimeString();
        this.statusPanel.innerHTML += `[${timestamp}] ${message}<br>`;
        this.statusPanel.scrollTop = this.statusPanel.scrollHeight;
      }
      
      updateStatus() {
        const status = `
输入: ${this.isInputEnabled ? '✅ 启用' : '❌ 禁用'} |
IME: ${this.isIMEEnabled ? '✅ 启用' : '❌ 禁用'} |
粘贴: ${this.isPasteEnabled ? '✅ 允许' : '❌ 禁止'} |
拖放: ${this.isDropEnabled ? '✅ 允许' : '❌ 禁止'}
        `.trim();
        
        // 更新第一个状态行
        const lines = this.statusPanel.innerHTML.split('<br>');
        lines[0] = `<strong>${status}</strong>`;
        this.statusPanel.innerHTML = lines.join('<br>');
      }
    }
    
    // 初始化控制器
    const controller = new TextareaController('completeControl');
    
    // 全局函数供按钮调用
    function enableInput() { controller.enableInput(); }
    function disableInput() { controller.disableInput(); }
    function enableIME() { controller.enableIME(); }
    function disableIME() { controller.disableIME(); }
    function clearTextarea() { controller.clear(); }
    function togglePaste() { controller.allowPaste(document.getElementById('allowPaste').checked); }
    function toggleDrop() { controller.allowDrop(document.getElementById('allowDrop').checked); }
  </script>
</body>
</html>