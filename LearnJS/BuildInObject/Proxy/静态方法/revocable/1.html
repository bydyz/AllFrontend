<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proxy.revocable() 方法详解</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4efe9 100%);
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        margin-bottom: 15px;
      }
      .subtitle {
        color: #7f8c8d;
        font-size: 1.2rem;
        margin-bottom: 20px;
      }
      .card-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 40px;
      }
      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .card h2 {
        color: #3498db;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }
      .code {
        background: #2d3436;
        color: #f5f6fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        overflow-x: auto;
        font-family: "Fira Code", monospace;
        font-size: 0.9rem;
      }
      .interactive-demo {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
      }
      .input-group {
        margin: 15px 0;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #2c3e50;
      }
      input,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        margin-bottom: 10px;
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
        margin: 10px 5px 10px 0;
      }
      button:hover {
        background: #2980b9;
      }
      .result {
        margin-top: 20px;
        padding: 20px;
        background: #edf2f7;
        border-radius: 5px;
        font-family: "Fira Code", monospace;
        white-space: pre-wrap;
      }
      .success {
        color: #27ae60;
      }
      .error {
        color: #e74c3c;
      }
      .highlight {
        background: #fffacd;
        padding: 2px 5px;
        border-radius: 3px;
      }
      .info-box {
        background: #e1f5fe;
        border-left: 4px solid #03a9f4;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 5px 5px 0;
      }
      footer {
        text-align: center;
        margin-top: 40px;
        color: #7f8c8d;
        padding: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f2f2f2;
      }
      .comparison-table {
        width: 100%;
        margin: 20px 0;
      }
      .comparison-table th,
      .comparison-table td {
        padding: 12px;
        text-align: center;
        border: 1px solid #ddd;
      }
      .comparison-table th {
        background-color: #3498db;
        color: white;
      }
      .comparison-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .explanation {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .step-by-step {
        margin: 20px 0;
        padding: 20px;
        background: #fff9e6;
        border-radius: 10px;
        border-left: 4px solid #ffcc00;
      }
      .step {
        margin-bottom: 15px;
        padding-left: 20px;
        position: relative;
      }
      .step:before {
        content: "→";
        position: absolute;
        left: 0;
        color: #ff9900;
        font-weight: bold;
      }
      .control-panel {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
      }
      .method-section {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }
      .use-case {
        margin: 20px 0;
        padding: 20px;
        background: #e8f5e9;
        border-radius: 10px;
        border-left: 4px solid #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Proxy.revocable() 方法详解</h1>
        <p class="subtitle">创建可撤销的代理对象，增强JavaScript元编程能力</p>
      </header>

      <div class="card-container">
        <div class="card">
          <h2>Proxy.revocable() 概述</h2>
          <p><code>Proxy.revocable()</code> 方法用于创建一个可撤销的Proxy对象。</p>

          <div class="code">// 语法 <br/>const { proxy, revoke } = Proxy.revocable(target, handler);</div>

          <p>该方法返回一个包含两个属性的对象：</p>
          <ul style="padding-left: 20px; margin: 15px 0">
            <li><code>proxy</code>: 代理对象，与new Proxy(target, handler)创建的相同</li>
            <li><code>revoke</code>: 撤销函数，调用后会使proxy无效</li>
          </ul>
        </div>

        <div class="card">
          <h2>与常规Proxy的区别</h2>
          <p><code>Proxy.revocable()</code> 与 <code>new Proxy()</code> 的主要区别：</p>

          <ul style="padding-left: 20px; margin: 15px 0">
            <li>返回一个包含proxy和revoke函数的对象</li>
            <li>可以通过调用revoke()函数使代理失效</li>
            <li>失效后所有对代理的操作都会抛出TypeError</li>
            <li>适用于需要临时或条件性代理的场景</li>
          </ul>

          <div class="info-box">
            <p><strong>优势：</strong> 提供了一种机制来限制代理对象的使用时间，增强安全性和资源管理。</p>
          </div>
        </div>

        <div class="card">
          <h2>基本用法示例</h2>
          <p>创建一个可撤销的代理对象：</p>

          <div class="code"  style="white-space: pre;">
const target = { message: "Hello, World!" };
const handler = {
  get: function(obj, prop) {
    return prop in obj ? obj[prop] : "属性不存在";
  }
};

const { proxy, revoke } = Proxy.revocable(target, handler);

console.log(proxy.message); // "Hello, World!"
console.log(proxy.other);   // "属性不存在"

// 撤销代理
revoke();

console.log(proxy.message); // TypeError: Cannot perform 'get' on a proxy that has been revoked
          </div>
        </div>
      </div>

      <div class="explanation">
        <h2>Proxy.revocable() 工作原理</h2>

        <div class="step-by-step">
          <h3>创建和使用过程:</h3>

          <div class="step">调用<code>Proxy.revocable(target, handler)</code>方法</div>
          <div class="step">返回一个包含<code>proxy</code>和<code>revoke</code>函数的对象</div>
          <div class="step">使用<code>proxy</code>对象就像使用常规代理一样</div>
          <div class="step">调用<code>revoke()</code>函数使代理失效</div>
          <div class="step">失效后所有对代理的操作都会抛出TypeError</div>
        </div>

        <div class="code" style="white-space: pre;">
// 创建可撤销代理
const { proxy, revoke } = Proxy.revocable(
  { value: 42 },
  {
    get: function(obj, prop) {
      return prop in obj ? obj[prop] : 0;
    }
  }
);

// 使用代理
console.log(proxy.value);  // 42
console.log(proxy.other);  // 0

// 撤销代理
revoke();

// 尝试使用已撤销的代理
try {
  console.log(proxy.value);  // 抛出TypeError
} catch (e) {
  console.error(e.toString());
}
        </div>
      </div>

      <div class="interactive-demo">
        <h2>可撤销代理演示</h2>

        <div class="code" style="white-space: pre;">
// 创建目标对象
const target = {
  name: "张三",
  age: 30,
  email: "zhangsan@example.com"
};

// 创建处理程序
const handler = {
  get: function(obj, prop) {
    if (prop === "age") {
      return `年龄: ${obj[prop]}`;
    }
    return obj[prop];
  },
  set: function(obj, prop, value) {
    if (prop === "age" && (value < 0 || value > 150)) {
      throw new RangeError("年龄无效");
    }
    obj[prop] = value;
    return true;
  }
};

// 创建可撤销代理
const { proxy, revoke } = Proxy.revocable(target, handler);
        </div>

        <div class="control-panel">
          <button onclick="demoGet()">读取属性 (proxy.name)</button>
          <button onclick="demoGetAge()">读取年龄 (proxy.age)</button>
          <button onclick="demoSet()">设置属性 (proxy.age = 35)</button>
          <button onclick="demoRevoke()">撤销代理 (revoke())</button>
          <button onclick="demoAfterRevoke()">撤销后尝试操作</button>
        </div>

        <div class="result" id="demoResult">演示结果将显示在这里...</div>
      </div>

      <div class="use-case">
        <h2>使用场景：临时访问控制</h2>

        <div class="code" style="white-space: pre;">
// 敏感数据对象
const sensitiveData = {
  apiKey: "1234567890abcdef",
  secret: "my-secret-value",
  userInfo: {
    name: "李四",
    id: "user-123"
  }
};

// 创建可撤销的只读代理
const { proxy, revoke } = Proxy.revocable(sensitiveData, {
  get: function(obj, prop) {
    // 允许访问用户信息，但隐藏敏感数据
    if (prop === "userInfo") {
      return obj[prop];
    }
    return "访问被拒绝";
  },
  set: function() {
    throw new Error("只读代理，不能修改");
  }
});

// 授予临时访问权限
console.log(proxy.userInfo); // { name: "李四", id: "user-123" }
console.log(proxy.apiKey);   // "访问被拒绝"

// 一段时间后撤销访问
setTimeout(() => {
  revoke();
  console.log("代理已撤销，访问权限已收回");
}, 5000);
        </div>

        <button onclick="demoAccessControl()">演示访问控制</button>

        <div class="result" id="accessControlResult">访问控制演示结果将显示在这里...</div>
      </div>

      <div class="use-case">
        <h2>使用场景：资源清理</h2>

        <div class="code" style="white-space: pre;">
// 模拟一个需要清理的资源
class Resource {
  constructor() {
    this.data = new Array(1000000).fill("大量数据");
    this.isActive = true;
  }
  
  getData() {
    if (!this.isActive) {
      throw new Error("资源已释放");
    }
    return this.data.slice(0, 10); // 返回部分数据
  }
  
  cleanup() {
    this.isActive = false;
    this.data = null;
    console.log("资源已清理");
  }
}

// 创建资源实例
const resource = new Resource();

// 创建可撤销代理，自动清理资源
const { proxy: resourceProxy, revoke } = Proxy.revocable(resource, {
  get: function(obj, prop) {
    if (prop === "cleanup") {
      return function() {
        obj.cleanup();
        revoke(); // 清理后撤销代理
      };
    }
    return obj[prop];
  }
});

// 使用资源
console.log(resourceProxy.getData()); // 正常工作

// 清理资源
resourceProxy.cleanup(); // 资源已清理

// 尝试再次使用
try {
  console.log(resourceProxy.getData()); // TypeError: 代理已撤销
} catch (e) {
  console.error(e.toString());
}
        </div>

        <button onclick="demoResourceCleanup()">演示资源清理</button>

        <div class="result" id="resourceCleanupResult">资源清理演示结果将显示在这里...</div>
      </div>

      <div class="method-section">
        <h2>注意事项和限制</h2>

        <div class="code" style="white-space: pre;">
// 1. 撤销后的代理无法恢复
const { proxy, revoke } = Proxy.revocable({ value: 42 }, {});
revoke();
// proxy现在永远不可用

// 2. 撤销只影响代理，不影响原始对象
const target = { value: 100 };
const { proxy, revoke } = Proxy.revocable(target, {});
revoke();
console.log(target.value); // 100 (原始对象仍然可用)

// 3. 多次调用revoke()不会产生额外效果
revoke(); // 第一次调用有效
revoke(); // 第二次调用无效果

// 4. 代理撤销后，所有操作都会抛出TypeError
try {
  console.log(proxy.value);
  proxy.newValue = 10;
  delete proxy.value;
  // 所有操作都会失败
} catch (e) {
  console.error("所有操作都失败:", e.toString());
}
        </div>

        <div class="info-box">
          <p><strong>重要：</strong> 一旦代理被撤销，就无法恢复。所有对代理的操作都会抛出TypeError，但原始目标对象不受影响。</p>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2023 Proxy.revocable() 方法详解 | JavaScript高级特性</p>
    </footer>

    <script src="./1.js"></script>
    <script>
      // 创建演示用的代理对象
      let revocableProxy = null;
      let revokeFunction = null;

      function initDemo() {
        const target = {
          name: "张三",
          age: 30,
          email: "zhangsan@example.com",
        };

        const handler = {
          get: function (obj, prop) {
            if (prop === "age") {
              return `年龄: ${obj[prop]}`;
            }
            return obj[prop];
          },
          set: function (obj, prop, value) {
            if (prop === "age" && (value < 0 || value > 150)) {
              throw new RangeError("年龄必须在0-150之间");
            }
            obj[prop] = value;
            return true;
          },
        };

        const { proxy, revoke } = Proxy.revocable(target, handler);
        revocableProxy = proxy;
        revokeFunction = revoke;

        document.getElementById("demoResult").innerHTML = "已创建可撤销代理对象。可以尝试各种操作。";
      }

      // 演示读取属性
      function demoGet() {
        if (!revocableProxy) {
          initDemo();
        }

        try {
          const result = revocableProxy.name;
          document.getElementById("demoResult").innerHTML = `读取 proxy.name: ${result}`;
        } catch (e) {
          document.getElementById("demoResult").innerHTML = `错误: ${e.toString()}`;
        }
      }

      // 演示读取年龄（特殊处理）
      function demoGetAge() {
        if (!revocableProxy) {
          initDemo();
        }

        try {
          const result = revocableProxy.age;
          document.getElementById("demoResult").innerHTML = `读取 proxy.age: ${result}`;
        } catch (e) {
          document.getElementById("demoResult").innerHTML = `错误: ${e.toString()}`;
        }
      }

      // 演示设置属性
      function demoSet() {
        if (!revocableProxy) {
          initDemo();
        }

        try {
          revocableProxy.age = 35;
          document.getElementById("demoResult").innerHTML = `设置 proxy.age = 35 成功。当前年龄: ${revocableProxy.age}`;
        } catch (e) {
          document.getElementById("demoResult").innerHTML = `错误: ${e.toString()}`;
        }
      }

      // 演示撤销代理
      function demoRevoke() {
        if (!revokeFunction) {
          document.getElementById("demoResult").innerHTML = "请先创建代理对象";
          return;
        }

        try {
          revokeFunction();
          document.getElementById("demoResult").innerHTML = "代理已撤销。现在所有操作都会抛出TypeError。";
        } catch (e) {
          document.getElementById("demoResult").innerHTML = `错误: ${e.toString()}`;
        }
      }

      // 演示撤销后尝试操作
      function demoAfterRevoke() {
        if (!revocableProxy) {
          document.getElementById("demoResult").innerHTML = "请先创建代理对象";
          return;
        }

        try {
          // 尝试各种操作
          revocableProxy.name;
          document.getElementById("demoResult").innerHTML = "代理仍然有效（尚未撤销）";
        } catch (e) {
          document.getElementById("demoResult").innerHTML = `代理已撤销，操作失败: ${e.toString()}`;
        }
      }

      // 演示访问控制
      function demoAccessControl() {
        const sensitiveData = {
          apiKey: "1234567890abcdef",
          secret: "my-secret-value",
          userInfo: {
            name: "李四",
            id: "user-123",
          },
        };

        const { proxy, revoke } = Proxy.revocable(sensitiveData, {
          get: function (obj, prop) {
            if (prop === "userInfo") {
              return obj[prop];
            }
            return "访问被拒绝";
          },
          set: function () {
            throw new Error("只读代理，不能修改");
          },
        });

        let result = "访问控制演示:\n\n";
        result += `proxy.userInfo: ${JSON.stringify(proxy.userInfo)}\n`;
        result += `proxy.apiKey: ${proxy.apiKey}\n`;
        result += `proxy.secret: ${proxy.secret}\n\n`;

        // 模拟一段时间后撤销
        result += "3秒后撤销代理...\n";

        setTimeout(() => {
          revoke();
          result += "代理已撤销，尝试访问:\n";

          try {
            proxy.userInfo;
          } catch (e) {
            result += `访问失败: ${e.toString()}`;
          }

          document.getElementById("accessControlResult").innerHTML = result;
        }, 3000);

        document.getElementById("accessControlResult").innerHTML = result;
      }

      // 演示资源清理
      function demoResourceCleanup() {
        class Resource {
          constructor() {
            this.data = ["数据1", "数据2", "数据3", "数据4", "数据5"];
            this.isActive = true;
          }

          getData() {
            if (!this.isActive) {
              throw new Error("资源已释放");
            }
            return this.data;
          }

          cleanup() {
            this.isActive = false;
            this.data = null;
            return "资源已清理";
          }
        }

        const resource = new Resource();

        const { proxy: resourceProxy, revoke } = Proxy.revocable(resource, {
          get: function (obj, prop) {
            if (prop === "cleanup") {
              return function () {
                const result = obj.cleanup();
                revoke();
                return result;
              };
            }
            return obj[prop];
          },
        });

        let result = "资源清理演示:\n\n";
        result += `初始数据: ${JSON.stringify(resourceProxy.getData())}\n`;
        result += `清理资源: ${resourceProxy.cleanup()}\n`;

        try {
          resourceProxy.getData();
        } catch (e) {
          result += `再次访问数据: ${e.toString()}\n`;
        }

        document.getElementById("resourceCleanupResult").innerHTML = result;
      }

      // 初始化页面时创建演示代理
      window.onload = initDemo;
    </script>
  </body>
</html>
