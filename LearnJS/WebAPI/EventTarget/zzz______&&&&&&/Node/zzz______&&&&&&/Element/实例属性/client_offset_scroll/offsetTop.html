<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>offsetTop å±æ€§è¯¦è§£</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #333;
        line-height: 1.6;
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 2.5rem;
      }

      .subtitle {
        color: #7f8c8d;
        font-size: 1.3rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .content {
        display: grid;
        grid-template-columns: 100%;
        margin-bottom: 40px;
      }

      .demo-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 40px;
      }

      .explanation-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #e74c3c;
      }

      h3 {
        color: #2c3e50;
        margin: 25px 0 15px 0;
      }

      .demo-container {
        position: relative;
        width: 100%;
        height: 500px;
        border: 2px solid #34495e;
        margin: 25px 0;
        background: #ecf0f1;
        padding: 30px;
        border-radius: 10px;
        overflow: hidden;
      }

      .hierarchy-container {
        position: relative;
        width: 100%;
        height: 100%;
        border: 2px solid #bdc3c7;
        border-radius: 8px;
        background: white;
        padding: 20px;
      }

      .level-1 {
        position: relative;
        width: 90%;
        height: 400px;
        margin: 0 auto;
        padding: 25px;
        border: 3px solid #3498db;
        background: #3498db11;
        border-radius: 8px;
      }

      .level-2 {
        position: relative;
        width: 80%;
        height: 300px;
        margin: 20px auto;
        padding: 20px;
        border: 3px solid #2ecc71;
        background: #2ecc7111;
        border-radius: 8px;
      }

      .level-3 {
        position: relative;
        width: 70%;
        height: 200px;
        margin: 20px auto;
        padding: 20px;
        border: 3px solid #e74c3c;
        background: #e74c3c11;
        border-radius: 8px;
      }

      .target-element {
        position: absolute;
        width: 120px;
        height: 80px;
        padding: 15px;
        background: #f39c12;
        border: 2px solid #d35400;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .offset-line {
        position: absolute;
        background: #e74c3c;
        pointer-events: none;
        z-index: 10;
      }

      .offset-line.horizontal {
        height: 2px;
        left: 0;
        right: 0;
      }

      .offset-line.vertical {
        width: 2px;
        top: 0;
        bottom: 0;
      }

      .offset-label {
        position: absolute;
        background: #e74c3c;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
        pointer-events: none;
        z-index: 11;
      }

      .position-marker {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #e74c3c;
        border-radius: 50%;
        pointer-events: none;
        z-index: 12;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 20px 0;
      }

      button {
        padding: 12px 15px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 600;
      }

      button:hover {
        background: #c0392b;
        transform: translateY(-2px);
      }

      button.secondary {
        background: #3498db;
      }

      button.secondary:hover {
        background: #2980b9;
      }

      .property-display {
        background: #2c3e50;
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .property-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 8px 12px;
        background: #34495e;
        border-radius: 6px;
      }

      .property-name {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .property-value {
        font-family: "Courier New", monospace;
        font-size: 1.2rem;
        color: #f1c40f;
        font-weight: bold;
      }

      .position-controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .control-group {
        margin: 15px 0;
      }

      .control-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
      }

      .range-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
      }

      .range-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #e74c3c;
        cursor: pointer;
      }

      .range-value {
        text-align: center;
        font-weight: bold;
        color: #e74c3c;
        margin-top: 5px;
      }

      .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .comparison-table th {
        background: #e74c3c;
        color: white;
        padding: 12px 15px;
        text-align: left;
      }

      .comparison-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #ecf0f1;
      }

      .comparison-table tr:nth-child(even) {
        background: #f8f9fa;
      }

      .code-block {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 10px;
        font-family: "Courier New", monospace;
        margin: 20px 0;
        overflow-x: auto;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre;
      }

      .special-cases {
        background: #fff9e6;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #f1c40f;
        margin: 20px 0;
      }

      .case-example {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid #e9ecef;
      }

      .offsetParent-demo {
        background: #e8f6f3;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border: 2px solid #1abc9c;
      }

      @media (max-width: 968px) {
        .content {
          grid-template-columns: 1fr;
        }

        .controls {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>offsetTop å±æ€§è¯¦è§£</h1>
        <p class="subtitle">æ·±å…¥ç†è§£ offsetTop çš„å·¥ä½œåŸç†ã€offsetParent ç‰¹æ€§å’Œå®é™…åº”ç”¨</p>
      </header>

      <div class="content">
        <div class="demo-section">
          <h2>äº¤äº’æ¼”ç¤º</h2>
          <p>ç§»åŠ¨ç›®æ ‡å…ƒç´ ï¼Œè§‚å¯Ÿ offsetTop å€¼ç›¸å¯¹äºä¸åŒ offsetParent çš„å˜åŒ–</p>

          <div class="demo-container">
            <div class="hierarchy-container">
              <div class="level-1" id="level1">
                <div class="level-2" id="level2">
                  <div class="level-3" id="level3">
                    <div class="target-element" id="targetElement">ç›®æ ‡å…ƒç´ </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="position-controls">
            <div class="control-group">
              <label class="control-label">ç›®æ ‡å…ƒç´ å‚ç›´ä½ç½®:</label>
              <input type="range" min="0" max="120" value="60" class="range-slider" id="verticalSlider" />
              <div class="range-value" id="verticalValue">60px</div>
            </div>

            <div class="control-group">
              <label class="control-label">ç›®æ ‡å…ƒç´ æ°´å¹³ä½ç½®:</label>
              <input type="range" min="0" max="200" value="100" class="range-slider" id="horizontalSlider" />
              <div class="range-value" id="horizontalValue">100px</div>
            </div>
          </div>

          <div class="controls">
            <button onclick="moveToTop()">ç§»åŠ¨åˆ°é¡¶éƒ¨</button>
            <button onclick="moveToCenter()">ç§»åŠ¨åˆ°ä¸­å¿ƒ</button>
            <button onclick="moveToBottom()">ç§»åŠ¨åˆ°åº•éƒ¨</button>
            <button class="secondary" onclick="changeOffsetParent('level3')">ç›¸å¯¹äº Level-3</button>
            <button class="secondary" onclick="changeOffsetParent('level2')">ç›¸å¯¹äº Level-2</button>
            <button class="secondary" onclick="changeOffsetParent('level1')">ç›¸å¯¹äº Level-1</button>
          </div>

          <div class="property-display">
            <h3 style="color: white; margin-top: 0">å®šä½å±æ€§å€¼</h3>
            <div class="property-item">
              <span class="property-name">offsetTop:</span>
              <span class="property-value" id="offsetTopVal">0px</span>
            </div>
            <div class="property-item">
              <span class="property-name">offsetLeft:</span>
              <span class="property-value" id="offsetLeftVal">0px</span>
            </div>
            <div class="property-item">
              <span class="property-name">offsetParent:</span>
              <span class="property-value" id="offsetParentVal">level-3</span>
            </div>
            <div class="property-item">
              <span class="property-name">offsetWidth:</span>
              <span class="property-value" id="offsetWidthVal">120px</span>
            </div>
            <div class="property-item">
              <span class="property-name">offsetHeight:</span>
              <span class="property-value" id="offsetHeightVal">80px</span>
            </div>
          </div>
        </div>

        <div class="explanation-section">
          <h2>offsetTop è¯¦è§£</h2>

          <div class="special-cases">
            <h3>ğŸ“Œ offsetTop æ ¸å¿ƒå®šä¹‰</h3>
            <p><strong>offsetTop = å…ƒç´ ä¸Šè¾¹ç•Œç›¸å¯¹äºå…¶ offsetParent ä¸Šè¾¹ç•Œçš„è·ç¦»</strong></p>
            <p>è¿™æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ï¼Œè¿”å›å…ƒç´ ç›¸å¯¹äºæœ€è¿‘å®šä½ç¥–å…ˆå…ƒç´ çš„å‚ç›´åç§»é‡ã€‚</p>
          </div>

          <h3>åŸºæœ¬æ¦‚å¿µ</h3>
          <div class="code-block">
// offsetTop è¡¨ç¤ºå…ƒç´ ç›¸å¯¹äº offsetParent çš„å‚ç›´è·ç¦»
element.offsetTop = å…ƒç´ é¡¶éƒ¨ åˆ° offsetParenté¡¶éƒ¨ çš„è·ç¦»

// offsetParent çš„ç¡®å®šè§„åˆ™ï¼š
// 1. æœ€è¿‘çš„å®šä½ç¥–å…ˆå…ƒç´  (position â‰  static)
// 2. å¦‚æœæ²¡æœ‰å®šä½ç¥–å…ˆï¼Œåˆ™æ˜¯æœ€è¿‘çš„ table, td, th, body
// 3. æœ€ç»ˆå›é€€åˆ° body å…ƒç´ 

// ç¤ºä¾‹
const element = document.getElementById('targetElement');

// è·å– offsetTop
console.log('offsetTop:', element.offsetTop);

// è·å– offsetParent
console.log('offsetParent:', element.offsetParent);
console.log('offsetParent tagName:', element.offsetParent.tagName);

// æ‰‹åŠ¨è®¡ç®—éªŒè¯
const rect = element.getBoundingClientRect();
const parentRect = element.offsetParent.getBoundingClientRect();
const calculatedOffsetTop = rect.top - parentRect.top;

console.log('è®¡ç®—å€¼:', calculatedOffsetTop);
console.log('å®é™…å€¼:', element.offsetTop);
console.log('æ˜¯å¦ç›¸ç­‰:', calculatedOffsetTop === element.offsetTop);
          </div>

          <h3>offsetParent çš„ç¡®å®šè§„åˆ™</h3>
          <div class="offsetParent-demo">
            <h4>offsetParent æŸ¥æ‰¾é¡ºåºæ¼”ç¤º</h4>
            <p>å°è¯•ç‚¹å‡»ä¸åŒçš„"ç›¸å¯¹äº"æŒ‰é’®ï¼Œè§‚å¯Ÿ offsetParent çš„å˜åŒ–</p>
            <div id="offsetParentInfo" style="padding: 10px; background: white; border-radius: 4px; font-size: 0.9rem"></div>
          </div>

          <div class="code-block">
// offsetParent æŸ¥æ‰¾ç®—æ³•
function findOffsetParent(element) {
    let current = element.parentElement;
    
    while (current && current !== document.body) {
        const style = getComputedStyle(current);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å®šä½å…ƒç´ 
        if (style.position !== 'static') {
            return current;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æ ¼ç›¸å…³å…ƒç´ 
        if (['TABLE', 'TD', 'TH'].includes(current.tagName)) {
            return current;
        }
        
        current = current.parentElement;
    }
    
    return document.body;
}

// éªŒè¯æŸ¥æ‰¾ç»“æœ
const element = document.getElementById('targetElement');
const foundParent = findOffsetParent(element);
const actualParent = element.offsetParent;

console.log('æŸ¥æ‰¾åˆ°çš„ offsetParent:', foundParent);
console.log('å®é™…çš„ offsetParent:', actualParent);
console.log('æ˜¯å¦ä¸€è‡´:', foundParent === actualParent);
          </div>

          <h3>ä¸å…¶ä»–å®šä½å±æ€§çš„å¯¹æ¯”</h3>
          <table class="comparison-table">
            <thead>
              <tr>
                <th>å±æ€§</th>
                <th>æè¿°</th>
                <th>å‚ç…§ç‰©</th>
                <th>æ˜¯å¦åŒ…å«æ»šåŠ¨</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>offsetTop</strong></td>
                <td>ç›¸å¯¹äº offsetParent çš„å‚ç›´è·ç¦»</td>
                <td>offsetParent</td>
                <td>å¦</td>
              </tr>
              <tr>
                <td>getBoundingClientRect().top</td>
                <td>ç›¸å¯¹äºè§†å£çš„å‚ç›´è·ç¦»</td>
                <td>è§†å£</td>
                <td>æ˜¯</td>
              </tr>
              <tr>
                <td>clientTop</td>
                <td>å…ƒç´ ä¸Šè¾¹æ¡†å®½åº¦</td>
                <td>å…ƒç´ è‡ªèº«</td>
                <td>ä¸é€‚ç”¨</td>
              </tr>
              <tr>
                <td>scrollTop</td>
                <td>å…ƒç´ å†…å®¹å‚ç›´æ»šåŠ¨è·ç¦»</td>
                <td>å…ƒç´ è‡ªèº«</td>
                <td>æ˜¯</td>
              </tr>
            </tbody>
          </table>

          <h3>ç‰¹æ®Šæƒ…å†µå’Œæ³¨æ„äº‹é¡¹</h3>

          <div class="case-example">
            <h4>æƒ…å†µ 1: éšè—å…ƒç´ å’Œ display: none</h4>
            <p>å¯¹äºéšè—å…ƒç´ ï¼ŒoffsetTop å¯èƒ½è¿”å› 0 æˆ–ä¸å¯é çš„å€¼ï¼š</p>
            <div class="code-block">
// éšè—å…ƒç´ çš„æƒ…å†µ
const hiddenElement = document.getElementById('hidden');

// display: none çš„å…ƒç´ 
hiddenElement.style.display = 'none';
console.log('éšè—å…ƒç´ çš„ offsetTop:', hiddenElement.offsetTop); // 0

// visibility: hidden çš„å…ƒç´ 
hiddenElement.style.visibility = 'hidden';
console.log('ä¸å¯è§å…ƒç´ çš„ offsetTop:', hiddenElement.offsetTop); // æ­£å¸¸å€¼

// opacity: 0 çš„å…ƒç´ 
hiddenElement.style.opacity = 0;
console.log('é€æ˜å…ƒç´ çš„ offsetTop:', hiddenElement.offsetTop); // æ­£å¸¸å€¼

// ç»“è®ºï¼šåªæœ‰å®Œå…¨ä»æ–‡æ¡£æµä¸­ç§»é™¤çš„å…ƒç´  offsetTop æ‰ä¸º 0
            </div>
          </div>

          <div class="case-example">
            <h4>æƒ…å†µ 2: è¡¨æ ¼å’Œç‰¹æ®Šå…ƒç´ </h4>
            <p>è¡¨æ ¼ç›¸å…³å…ƒç´ çš„ offsetParent è¡Œä¸ºç‰¹æ®Šï¼š</p>
            <div class="code-block">
// è¡¨æ ¼ä¸­çš„å…ƒç´ 
const tableCell = document.querySelector('td');
const cellContent = tableCell.querySelector('.content');

console.log('è¡¨æ ¼å•å…ƒæ ¼çš„ offsetParent:', tableCell.offsetParent);
console.log('å•å…ƒæ ¼å†…å®¹çš„ offsetParent:', cellContent.offsetParent);

// å¯¹äºè¡¨æ ¼ä¸­çš„å…ƒç´ ï¼ŒoffsetParent é€šå¸¸æ˜¯æœ€è¿‘çš„ table, td, th æˆ– body
// å³ä½¿è¿™äº›å…ƒç´ æ²¡æœ‰è®¾ç½®å®šä½

// å›ºå®šå®šä½å…ƒç´ çš„ç‰¹æ®Šæƒ…å†µ
const fixedElement = document.querySelector('.fixed');
console.log('å›ºå®šå®šä½å…ƒç´ çš„ offsetParent:', fixedElement.offsetParent); // é€šå¸¸æ˜¯ null
            </div>
          </div>

          <div class="case-example">
            <h4>æƒ…å†µ 3: å˜æ¢(transform)çš„å½±å“</h4>
            <p>CSS transform ä¸ä¼šå½±å“ offsetTopï¼š</p>
            <div class="code-block">
// transform å¯¹ offsetTop çš„å½±å“
const element = document.getElementById('target');

// åº”ç”¨ transform
element.style.transform = 'translateY(100px)';
console.log('åº”ç”¨ transform åçš„ offsetTop:', element.offsetTop); // ä¸å˜

// transform æ”¹å˜è§†è§‰ä½ç½®ï¼Œä½†ä¸æ”¹å˜å¸ƒå±€ä½ç½®
// offsetTop ä»ç„¶åæ˜ å…ƒç´ åœ¨æ­£å¸¸æ–‡æ¡£æµä¸­çš„ä½ç½®

// è·å–è§†è§‰ä½ç½®éœ€è¦ä½¿ç”¨ getBoundingClientRect()
const rect = element.getBoundingClientRect();
console.log('è§†è§‰ä¸Šçš„é¡¶éƒ¨ä½ç½®:', rect.top);
            </div>
          </div>

          <h3>å®é™…åº”ç”¨åœºæ™¯</h3>
          <div class="code-block">
// åº”ç”¨ 1: å…ƒç´ ä½ç½®æ£€æµ‹å’Œç¢°æ’æ£€æµ‹
class PositionTracker {
    constructor(element) {
        this.element = element;
        this.update();
    }
    
    update() {
        this.offsetTop = this.element.offsetTop;
        this.offsetLeft = this.element.offsetLeft;
        this.offsetParent = this.element.offsetParent;
        
        // è®¡ç®—åœ¨æ–‡æ¡£ä¸­çš„ç»å¯¹ä½ç½®
        this.absoluteTop = this.calculateAbsoluteTop();
        this.absoluteLeft = this.calculateAbsoluteLeft();
    }
    
    calculateAbsoluteTop() {
        let top = this.offsetTop;
        let current = this.offsetParent;
        
        while (current && current !== document.body) {
            top += current.offsetTop;
            current = current.offsetParent;
        }
        
        return top;
    }
    
    calculateAbsoluteLeft() {
        let left = this.offsetLeft;
        let current = this.offsetParent;
        
        while (current && current !== document.body) {
            left += current.offsetLeft;
            current = current.offsetParent;
        }
        
        return left;
    }
    
    isCollidingWith(otherElement) {
        const otherTracker = new PositionTracker(otherElement);
        
        const thisRect = {
            top: this.absoluteTop,
            left: this.absoluteLeft,
            right: this.absoluteLeft + this.element.offsetWidth,
            bottom: this.absoluteTop + this.element.offsetHeight
        };
        
        const otherRect = {
            top: otherTracker.absoluteTop,
            left: otherTracker.absoluteLeft,
            right: otherTracker.absoluteLeft + otherElement.offsetWidth,
            bottom: otherTracker.absoluteTop + otherElement.offsetHeight
        };
        
        return !(
            thisRect.right < otherRect.left ||
            thisRect.left > otherRect.right ||
            thisRect.bottom < otherRect.top ||
            thisRect.top > otherRect.bottom
        );
    }
}

// åº”ç”¨ 2: æ»šåŠ¨åˆ°å…ƒç´ ä½ç½®
function scrollToElement(targetElement, container) {
    const offsetTop = targetElement.offsetTop;
    const offsetParent = targetElement.offsetParent;
    
    // å¦‚æœç›®æ ‡å…ƒç´ åœ¨å®¹å™¨å†…ï¼Œæ»šåŠ¨åˆ°è¯¥ä½ç½®
    if (offsetParent === container || container.contains(targetElement)) {
        container.scrollTop = offsetTop - (container.clientHeight - targetElement.offsetHeight) / 2;
    } else {
        // è®¡ç®—åœ¨æ–‡æ¡£ä¸­çš„ç»å¯¹ä½ç½®
        const absoluteTop = calculateAbsoluteTop(targetElement);
        window.scrollTo({
            top: absoluteTop - window.innerHeight / 2,
            behavior: 'smooth'
        });
    }
}

function calculateAbsoluteTop(element) {
    let top = element.offsetTop;
    let current = element.offsetParent;
    
    while (current && current !== document.body) {
        top += current.offsetTop;
        current = current.offsetParent;
    }
    
    return top;
}

// åº”ç”¨ 3: æ‹–æ‹½å®šä½ç³»ç»Ÿ
class DragPositioning {
    constructor(draggableElement, container) {
        this.element = draggableElement;
        this.container = container;
        this.isDragging = false;
        this.setup();
    }
    
    setup() {
        this.element.addEventListener('mousedown', (e) => {
            this.startDrag(e);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (this.isDragging) {
                this.drag(e);
            }
        });
        
        document.addEventListener('mouseup', () => {
            this.stopDrag();
        });
    }
    
    startDrag(e) {
        this.isDragging = true;
        this.dragStartX = e.clientX - this.element.offsetLeft;
        this.dragStartY = e.clientY - this.element.offsetTop;
    }
    
    drag(e) {
        const newLeft = e.clientX - this.dragStartX;
        const newTop = e.clientY - this.dragStartY;
        
        // é™åˆ¶åœ¨å®¹å™¨èŒƒå›´å†…
        const maxLeft = this.container.offsetWidth - this.element.offsetWidth;
        const maxTop = this.container.offsetHeight - this.element.offsetHeight;
        
        this.element.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
        this.element.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
        
        // æ›´æ–°ä½ç½®ä¿¡æ¯æ˜¾ç¤º
        this.updatePositionInfo();
    }
    
    stopDrag() {
        this.isDragging = false;
    }
    
    updatePositionInfo() {
        console.log('å½“å‰ä½ç½® - offsetTop:', this.element.offsetTop);
        console.log('å½“å‰ä½ç½® - offsetLeft:', this.element.offsetLeft);
    }
}

// åº”ç”¨ 4: å“åº”å¼å¸ƒå±€æ£€æµ‹
function setupLayoutDetection() {
    const elements = document.querySelectorAll('.layout-element');
    
    function checkElementPositions() {
        elements.forEach(element => {
            const offsetTop = element.offsetTop;
            const offsetLeft = element.offsetLeft;
            const viewportHeight = window.innerHeight;
            
            // æ£€æµ‹å…ƒç´ æ˜¯å¦åœ¨é¦–å±
            const isAboveFold = offsetTop < viewportHeight;
            
            // æ ¹æ®ä½ç½®åº”ç”¨ä¸åŒçš„æ ·å¼æˆ–è¡Œä¸º
            if (isAboveFold) {
                element.classList.add('above-fold');
                element.classList.remove('below-fold');
            } else {
                element.classList.add('below-fold');
                element.classList.remove('above-fold');
            }
            
            // è®°å½•ä½ç½®ä¿¡æ¯ç”¨äºåˆ†æ
            element.dataset.offsetTop = offsetTop;
            element.dataset.offsetLeft = offsetLeft;
        });
    }
    
    // åˆå§‹æ£€æµ‹
    checkElementPositions();
    
    // ç›‘å¬æ»šåŠ¨å’Œçª—å£å¤§å°å˜åŒ–
    window.addEventListener('scroll', checkElementPositions);
    window.addEventListener('resize', checkElementPositions);
}

// åº”ç”¨ 5: è™šæ‹Ÿåˆ—è¡¨å®ç°
class VirtualList {
    constructor(container, itemHeight, totalItems, renderItem) {
        this.container = container;
        this.itemHeight = itemHeight;
        this.totalItems = totalItems;
        this.renderItem = renderItem;
        this.visibleItemCount = Math.ceil(container.clientHeight / itemHeight);
        this.setup();
    }
    
    setup() {
        this.container.addEventListener('scroll', () => {
            this.renderVisibleItems();
        });
        
        this.renderVisibleItems();
    }
    
    renderVisibleItems() {
        const scrollTop = this.container.scrollTop;
        const startIndex = Math.floor(scrollTop / this.itemHeight);
        const endIndex = Math.min(startIndex + this.visibleItemCount + 2, this.totalItems);
        
        // æ¸…é™¤ç°æœ‰å†…å®¹
        this.container.innerHTML = '';
        
        // è®¾ç½®å®¹å™¨é«˜åº¦ä»¥ä¿æŒæ­£ç¡®çš„æ»šåŠ¨æ¡
        this.container.style.height = (this.totalItems * this.itemHeight) + 'px';
        
        // æ¸²æŸ“å¯è§é¡¹
        for (let i = startIndex; i <= endIndex && i < this.totalItems; i++) {
            const item = this.renderItem(i);
            item.style.position = 'absolute';
            item.style.top = (i * this.itemHeight) + 'px';
            item.style.height = this.itemHeight + 'px';
            this.container.appendChild(item);
        }
    }
    
    getItemPosition(index) {
        return index * this.itemHeight;
    }
    
    scrollToItem(index) {
        const targetPosition = this.getItemPosition(index);
        this.container.scrollTop = targetPosition;
    }
}
          </div>

          <h3>æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ</h3>
          <div class="special-cases">
            <p><strong>offsetTop ä¼šè§¦å‘é‡æ’ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„ï¼š</strong></p>
            <ul>
              <li>é¿å…åœ¨å¾ªç¯æˆ–é¢‘ç¹è°ƒç”¨çš„å‡½æ•°ä¸­è¯»å– offsetTop</li>
              <li>æ‰¹é‡è¯»å–å¤šä¸ªå…ƒç´ çš„ offsetTop å€¼</li>
              <li>ä½¿ç”¨ç¼“å­˜æœºåˆ¶å­˜å‚¨è®¡ç®—ç»“æœ</li>
              <li>è€ƒè™‘ä½¿ç”¨ getBoundingClientRect() è·å–å¤šä¸ªå€¼</li>
            </ul>
            <div class="code-block">
// æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
class OptimizedPositionManager {
    constructor() {
        this.cache = new Map();
        this.setup();
    }
    
    setup() {
        // ä½¿ç”¨ ResizeObserver ç›‘å¬å°ºå¯¸å˜åŒ–
        this.resizeObserver = new ResizeObserver((entries) => {
            entries.forEach(entry => {
                this.cache.delete(entry.target);
            });
        });
    }
    
    getOffsetTop(element) {
        if (this.cache.has(element)) {
            return this.cache.get(element);
        }
        
        const offsetTop = element.offsetTop;
        this.cache.set(element, offsetTop);
        
        // å¼€å§‹è§‚å¯Ÿå…ƒç´ å˜åŒ–
        this.resizeObserver.observe(element);
        
        return offsetTop;
    }
    
    batchGetPositions(elements) {
        // ä¸€æ¬¡æ€§è¯»å–å¤šä¸ªå…ƒç´ çš„ä½ç½®ï¼Œå‡å°‘é‡æ’æ¬¡æ•°
        const positions = elements.map(element => ({
            element,
            offsetTop: this.getOffsetTop(element),
            offsetLeft: element.offsetLeft,
            offsetParent: element.offsetParent
        }));
        
        return positions;
    }
    
    // ä½¿ç”¨ getBoundingClientRect() è·å–å¤šä¸ªå€¼
    getComprehensivePosition(element) {
        const rect = element.getBoundingClientRect();
        const offsetTop = element.offsetTop;
        const offsetLeft = element.offsetLeft;
        
        return {
            // offsetTop ç›¸å…³
            offsetTop,
            absoluteTop: this.calculateAbsoluteTop(element),
            viewportTop: rect.top,
            
            // å…¶ä»–ä½ç½®ä¿¡æ¯
            offsetLeft,
            absoluteLeft: this.calculateAbsoluteLeft(element),
            viewportLeft: rect.left,
            
            // å°ºå¯¸ä¿¡æ¯
            width: element.offsetWidth,
            height: element.offsetHeight,
            clientWidth: element.clientWidth,
            clientHeight: element.clientHeight
        };
    }
}
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // è·å–DOMå…ƒç´ 
      const targetElement = document.getElementById("targetElement");
      const level1 = document.getElementById("level1");
      const level2 = document.getElementById("level2");
      const level3 = document.getElementById("level3");

      // è·å–æ˜¾ç¤ºå…ƒç´ 
      const offsetTopVal = document.getElementById("offsetTopVal");
      const offsetLeftVal = document.getElementById("offsetLeftVal");
      const offsetParentVal = document.getElementById("offsetParentVal");
      const offsetWidthVal = document.getElementById("offsetWidthVal");
      const offsetHeightVal = document.getElementById("offsetHeightVal");
      const offsetParentInfo = document.getElementById("offsetParentInfo");

      // è·å–æ§åˆ¶å…ƒç´ 
      const verticalSlider = document.getElementById("verticalSlider");
      const horizontalSlider = document.getElementById("horizontalSlider");
      const verticalValue = document.getElementById("verticalValue");
      const horizontalValue = document.getElementById("horizontalValue");

      // çŠ¶æ€å˜é‡
      let currentOffsetParent = level3;
      let isDragging = false;
      let dragStartX, dragStartY, originalLeft, originalTop;

      // æ›´æ–°å±æ€§æ˜¾ç¤º
      function updateProperties() {
        const offsetTop = targetElement.offsetTop;
        const offsetLeft = targetElement.offsetLeft;
        const offsetParent = targetElement.offsetParent;
        const offsetWidth = targetElement.offsetWidth;
        const offsetHeight = targetElement.offsetHeight;

        offsetTopVal.textContent = offsetTop + "px";
        offsetLeftVal.textContent = offsetLeft + "px";
        offsetParentVal.textContent = getElementName(offsetParent);
        offsetWidthVal.textContent = offsetWidth + "px";
        offsetHeightVal.textContent = offsetHeight + "px";

        // æ›´æ–°å¯è§†åŒ–
        updateVisualization();

        // æ›´æ–° offsetParent ä¿¡æ¯
        updateOffsetParentInfo();
      }

      // è·å–å…ƒç´ åç§°
      function getElementName(element) {
        if (element === level1) return "level-1";
        if (element === level2) return "level-2";
        if (element === level3) return "level-3";
        if (element === document.body) return "body";
        return element.id || element.tagName.toLowerCase();
      }

      // æ›´æ–°å¯è§†åŒ–
      function updateVisualization() {
        // æ¸…é™¤æ—§çš„å¯è§†åŒ–å…ƒç´ 
        document.querySelectorAll(".offset-line, .offset-label, .position-marker").forEach(el => el.remove());

        const offsetTop = targetElement.offsetTop;
        const offsetLeft = targetElement.offsetLeft;
        const offsetParent = targetElement.offsetParent;

        // åˆ›å»ºæ°´å¹³åç§»çº¿
        const horizontalLine = document.createElement("div");
        horizontalLine.className = "offset-line horizontal";
        horizontalLine.style.top = offsetTop + targetElement.offsetHeight / 2 + "px";
        offsetParent.appendChild(horizontalLine);

        // åˆ›å»ºå‚ç›´åç§»çº¿
        const verticalLine = document.createElement("div");
        verticalLine.className = "offset-line vertical";
        verticalLine.style.left = offsetLeft + targetElement.offsetWidth / 2 + "px";
        offsetParent.appendChild(verticalLine);

        // åˆ›å»º offsetTop æ ‡ç­¾
        const topLabel = document.createElement("div");
        topLabel.className = "offset-label";
        topLabel.style.top = offsetTop / 2 + "px";
        topLabel.style.left = "10px";
        topLabel.textContent = `offsetTop: ${offsetTop}px`;
        offsetParent.appendChild(topLabel);

        // åˆ›å»º offsetLeft æ ‡ç­¾
        const leftLabel = document.createElement("div");
        leftLabel.className = "offset-label";
        leftLabel.style.top = "10px";
        leftLabel.style.left = offsetLeft / 2 + "px";
        leftLabel.textContent = `offsetLeft: ${offsetLeft}px`;
        offsetParent.appendChild(leftLabel);

        // åˆ›å»ºä½ç½®æ ‡è®°
        const topMarker = document.createElement("div");
        topMarker.className = "position-marker";
        topMarker.style.top = offsetTop + "px";
        topMarker.style.left = offsetLeft + targetElement.offsetWidth / 2 + "px";
        offsetParent.appendChild(topMarker);

        const leftMarker = document.createElement("div");
        leftMarker.className = "position-marker";
        leftMarker.style.top = offsetTop + targetElement.offsetHeight / 2 + "px";
        leftMarker.style.left = offsetLeft + "px";
        offsetParent.appendChild(leftMarker);
      }

      // æ›´æ–° offsetParent ä¿¡æ¯
      function updateOffsetParentInfo() {
        const offsetParent = targetElement.offsetParent;
        const parentStyle = getComputedStyle(offsetParent);

        let info = `
                <strong>å½“å‰ offsetParent:</strong> ${getElementName(offsetParent)}<br>
                <strong>position å±æ€§:</strong> ${parentStyle.position}<br>
                <strong>offsetTop:</strong> ${offsetParent.offsetTop}px<br>
                <strong>offsetLeft:</strong> ${offsetParent.offsetLeft}px
            `;

        // æ˜¾ç¤ºæŸ¥æ‰¾è·¯å¾„
        info += `<br><br><strong>offsetParent æŸ¥æ‰¾è·¯å¾„:</strong><br>`;
        let current = targetElement;
        let path = [];

        while (current && current !== document.body) {
          path.push(getElementName(current));
          current = current.offsetParent;
        }
        path.push("body");

        info += path.join(" â†’ ");

        offsetParentInfo.innerHTML = info;
      }

      // æ§åˆ¶å‡½æ•°
      function moveToTop() {
        targetElement.style.top = "0px";
        targetElement.style.left = "50%";
        targetElement.style.transform = "translateX(-50%)";
        updateProperties();
      }

      function moveToCenter() {
        const parent = currentOffsetParent;
        const centerX = (parent.offsetWidth - targetElement.offsetWidth) / 2;
        const centerY = (parent.offsetHeight - targetElement.offsetHeight) / 2;

        targetElement.style.top = centerY + "px";
        targetElement.style.left = centerX + "px";
        updateProperties();
      }

      function moveToBottom() {
        const parent = currentOffsetParent;
        const bottomY = parent.offsetHeight - targetElement.offsetHeight;

        targetElement.style.top = bottomY + "px";
        targetElement.style.left = "50%";
        targetElement.style.transform = "translateX(-50%)";
        updateProperties();
      }

      function changeOffsetParent(parentId) {
        const newParent = document.getElementById(parentId);

        // ç§»é™¤ç›®æ ‡å…ƒç´ ä»å½“å‰çˆ¶çº§
        targetElement.parentElement.removeChild(targetElement);

        // æ·»åŠ åˆ°æ–°çš„çˆ¶çº§
        newParent.appendChild(targetElement);

        // é‡ç½®ä½ç½®åˆ°ä¸­å¿ƒ
        moveToCenter();

        currentOffsetParent = newParent;
        updateProperties();
      }

      // æ‹–æ‹½åŠŸèƒ½
      function setupDragging() {
        targetElement.addEventListener("mousedown", startDrag);
        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", stopDrag);
      }

      function startDrag(e) {
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        originalLeft = parseInt(targetElement.style.left) || 0;
        originalTop = parseInt(targetElement.style.top) || 0;

        targetElement.style.cursor = "grabbing";
        e.preventDefault();
      }

      function drag(e) {
        if (!isDragging) return;

        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;

        const newLeft = originalLeft + deltaX;
        const newTop = originalTop + deltaY;

        // é™åˆ¶åœ¨çˆ¶å…ƒç´ èŒƒå›´å†…
        const parent = currentOffsetParent;
        const maxLeft = parent.offsetWidth - targetElement.offsetWidth;
        const maxTop = parent.offsetHeight - targetElement.offsetHeight;

        targetElement.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + "px";
        targetElement.style.top = Math.max(0, Math.min(newTop, maxTop)) + "px";

        updateProperties();
      }

      function stopDrag() {
        isDragging = false;
        targetElement.style.cursor = "move";
      }

      // äº‹ä»¶ç›‘å¬
      verticalSlider.addEventListener("input", function () {
        const value = parseInt(this.value);
        targetElement.style.top = value + "px";
        verticalValue.textContent = value + "px";
        updateProperties();
      });

      horizontalSlider.addEventListener("input", function () {
        const value = parseInt(this.value);
        targetElement.style.left = value + "px";
        horizontalValue.textContent = value + "px";
        updateProperties();
      });

      // åˆå§‹åŒ–æ‹–æ‹½
      setupDragging();

      // åˆå§‹åŒ–
      updateProperties();

      // æ§åˆ¶å°æ¼”ç¤º
      setTimeout(() => {
        console.log("=== offsetTop å±æ€§æ¼”ç¤º ===");
        console.log("åˆå§‹ offsetTop:", targetElement.offsetTop);
        console.log("offsetParent:", targetElement.offsetParent);
        console.log("offsetParent çš„ position:", getComputedStyle(targetElement.offsetParent).position);

        // æ¼”ç¤º offsetParent æŸ¥æ‰¾
        console.log("\nğŸ” offsetParent æŸ¥æ‰¾æ¼”ç¤º:");
        let current = targetElement;
        console.log("æŸ¥æ‰¾è·¯å¾„:");
        while (current && current !== document.body) {
          console.log(`${getElementName(current)} â†’ offsetParent: ${getElementName(current.offsetParent)}`);
          current = current.offsetParent;
        }

        // æ¼”ç¤ºæ‰‹åŠ¨è®¡ç®—
        console.log("\nğŸ§® æ‰‹åŠ¨è®¡ç®—éªŒè¯:");
        const rect = targetElement.getBoundingClientRect();
        const parentRect = targetElement.offsetParent.getBoundingClientRect();
        const calculatedOffsetTop = rect.top - parentRect.top;

        console.log("å…ƒç´ é¡¶éƒ¨ä½ç½®:", rect.top);
        console.log("offsetParent é¡¶éƒ¨ä½ç½®:", parentRect.top);
        console.log("è®¡ç®— offsetTop:", calculatedOffsetTop);
        console.log("å®é™… offsetTop:", targetElement.offsetTop);
        console.log("æ˜¯å¦ç›¸ç­‰:", calculatedOffsetTop === targetElement.offsetTop);
      }, 1000);
    </script>
  </body>
</html>
